# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Check if backup network_spec.yml exists
  ansible.builtin.stat:
    path: "{{ backup_location }}/network_spec.yml"
  register: backup_network_spec_stat

- name: Fail if backup network_spec.yml is not present
  ansible.builtin.fail:
    msg: "{{ msg_backup_network_spec_missing }}"
  when: not backup_network_spec_stat.stat.exists

- name: Check if network_spec.yml exists
  ansible.builtin.stat:
    path: "{{ input_project_dir }}/network_spec.yml"
  register: network_spec_stat

- name: Fail if network_spec.yml is not present
  ansible.builtin.fail:
    msg: "{{ msg_network_spec_missing }}"
  when: not network_spec_stat.stat.exists

- name: Read backup network_spec.yml (source of truth)
  ansible.builtin.slurp:
    src: "{{ backup_location }}/network_spec.yml"
  register: backup_network_spec_slurp

- name: Parse backup network_spec.yml
  ansible.builtin.set_fact:
    backup_network_spec: "{{ backup_network_spec_slurp.content | b64decode | from_yaml }}"

- name: Extract admin_network and ib_network from backup file
  ansible.builtin.set_fact:
    admin_network: >-
      {{
        (backup_network_spec.admin_network
          if (backup_network_spec is mapping and backup_network_spec.admin_network is defined)
          else
            (
              (backup_network_spec.Networks | default([])
                | select('mapping')
                | selectattr('admin_network', 'defined')
                | map(attribute='admin_network')
                | first
              ) | default({})
            )
        )
      }}
    ib_network: >-
      {{
        (backup_network_spec.ib_network
          if (backup_network_spec is mapping and backup_network_spec.ib_network is defined)
          else
            (
              (backup_network_spec.Networks | default([])
                | select('mapping')
                | selectattr('ib_network', 'defined')
                | map(attribute='ib_network')
                | first
              ) | default({})
            )
        )
      }}
  when:
    - true

- name: Render network_spec.yml in Omnia 2.1 format
  ansible.builtin.template:
    src: network_spec.j2
    dest: "{{ input_project_dir }}/network_spec.yml"
    mode: "{{ default_file_mode }}"
  vars:
    admin_network_netmask_bits: "{{ admin_network.netmask_bits | default('24') }}"
  when: true

- name: Read transformed network_spec.yml
  ansible.builtin.slurp:
    src: "{{ input_project_dir }}/network_spec.yml"
  register: network_spec_21_slurp
  when: true

- name: Parse transformed network_spec.yml
  ansible.builtin.set_fact:
    network_spec_21: "{{ network_spec_21_slurp.content | b64decode | from_yaml }}"
  when: true

- name: Validate YAML syntax of transformed network_spec.yml
  ansible.builtin.command:
    cmd: python3 -c "import yaml; yaml.safe_load(open('{{ input_project_dir }}/network_spec.yml','r'))"
  register: network_spec_yaml_validation
  changed_when: false
  when: true

- name: Fail if YAML validation fails
  ansible.builtin.fail:
    msg: "{{ msg_yaml_validation_failed }}"
  when:
    - network_spec_yaml_validation.rc != 0

- name: Ensure ib_network.netmask_bits matches admin_network.netmask_bits
  ansible.builtin.fail:
    msg: "{{ msg_ib_netmask_mismatch }}"
  when:
    - >-
      (ib_network.netmask_bits | default(admin_network.netmask_bits | default('24')) | string)
      != (admin_network.netmask_bits | default('24') | string)

- name: Display backup path (no-op when skipped)
  ansible.builtin.debug:
    msg: "{{ msg_using_backup_network_spec }}"
  when: true

- name: Validate mandatory ib_network is present in transformed output
  ansible.builtin.fail:
    msg: "{{ msg_ib_network_missing }}"
  when:
    - >-
      (network_spec_21.Networks is not defined)
      or ((network_spec_21.Networks | select('mapping') | selectattr('ib_network', 'defined') | list | length) == 0)

- name: Extract ib_network subnet from transformed output
  ansible.builtin.set_fact:
    ib_network_subnet: >-
      {{
        (
          network_spec_21.Networks
          | select('mapping')
          | selectattr('ib_network', 'defined')
          | map(attribute='ib_network')
          | first
          | default({})
        ).subnet | default('')
      }}

- name: Validate mandatory ib_network.subnet is present in transformed output
  ansible.builtin.fail:
    msg: "{{ msg_ib_subnet_missing }}"
  when:
    - >-
      (ib_network_subnet | string | trim) == ''

- name: Display transformation summary
  ansible.builtin.debug:
    msg: "{{ msg_network_spec_transform_summary }}"
