---

- name: Include variable file omnia_config.yml
  ansible.builtin.include_vars: "{{ hostvars['localhost']['input_project_dir'] }}/omnia_config.yml"

- name: Include storage vars
  ansible.builtin.include_vars: "{{ hostvars['localhost']['input_project_dir'] }}/storage_config.yml"

- name: Set facts for slurm
  ansible.builtin.set_fact:
    nfs_storage_name: "{{ slurm_cluster[0].nfs_storage_name }}"

- name: Read the slurm mount point
  ansible.builtin.set_fact:
    share_path: "{{ (nfs_client_params | selectattr('nfs_name', 'equalto', nfs_storage_name) | first).client_share_path }}"

- name: Display resolved slurm share path
  ansible.builtin.debug:
    msg: "Resolved share_path={{ share_path }} (nfs_storage_name={{ nfs_storage_name }})"

- name: Slurp remote YAML file
  ansible.builtin.slurp:
    src: "{{ hostvars['localhost']['oim_shared_path'] }}/omnia/openchami/workdir/nodes/nodes.yaml"
  register: slurped_yaml

- name: Parse YAML into vars
  ansible.builtin.set_fact:
    node_yaml: "{{ slurped_yaml.content | b64decode | from_yaml }}"

- name: Read the node name group
  ansible.builtin.set_fact:
    name_group_map: "{{ node_yaml.nodes | items2dict(key_name='name', value_name='group') }}"

- name: Group the functional_groups
  ansible.builtin.set_fact:
    tmp_grouped_nodes: "{{ name_group_map | dict2items | groupby('value') }}"

- name: Re-organize the groups
  ansible.builtin.set_fact:
    grouped_nodes: "{{ grouped_nodes | default({}) | combine({item[0]: ((item[1] | items2dict).keys() | list)}) }}"
  loop: "{{ tmp_grouped_nodes }}"

- name: Assign slurm lists
  ansible.builtin.set_fact:
    ctld_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^' ~ 'slurm_control_node_')
                   | map(attribute='value') | list | flatten }}"

- name: Fail if Slurm controller list is empty
  ansible.builtin.fail:
    msg: "Slurm controller functional group is missing from PXE mapping file. Please update the file and rerun."
  when: ctld_list | length == 0

- name: Set slurm_config_path
  ansible.builtin.set_fact:
    slurm_config_path: "{{ share_path }}/{{ slurm_share_dir_name }}"

- name: Display resolved slurm config path
  ansible.builtin.debug:
    msg: "Resolved slurm_config_path={{ slurm_config_path }}"

- name: Prompt for backup base name
  ansible.builtin.pause:
    prompt: "Enter backup base name (leave empty for timestamp-only)"
  register: backup_base_name_input

- name: Set backup id
  ansible.builtin.set_fact:
    backup_timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.time | replace(':', '-') }}"
    backup_base_name: "{{ backup_base_name_input.user_input | default('') }}"

- name: Set backup name suffix
  ansible.builtin.set_fact:
    backup_name_suffix: "{{ (backup_base_name | length > 0) | ternary(backup_base_name ~ '_' ~ backup_timestamp, backup_timestamp) }}"

- name: Set backup directory
  ansible.builtin.set_fact:
    slurm_backups_root: "{{ share_path }}/{{ slurm_backups_dir_name }}"
    backup_id: "{{ backup_name_suffix }}"
    backup_dir: "{{ share_path }}/{{ slurm_backups_dir_name }}/{{ backup_name_suffix }}"

- name: Ensure slurm backups root exists
  ansible.builtin.file:
    path: "{{ slurm_backups_root }}"
    state: directory
    mode: '0755'

- name: Display slurm backups root
  ansible.builtin.debug:
    msg: "Resolved slurm_backups_root={{ slurm_backups_root }}"

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    mode: '0755'

- name: Create backup config directories
  ansible.builtin.file:
    path: "{{ backup_dir }}/{{ ctld_list[0] }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - etc/slurm
    - etc/munge
    - etc/my.cnf.d

- name: Backup controller config directories
  ansible.builtin.command: >-
    cp -a "{{ slurm_config_path }}/{{ ctld_list[0] }}/{{ item }}/." "{{ backup_dir }}/{{ ctld_list[0] }}/{{ item }}/"
  loop:
    - etc/slurm
    - etc/munge
    - etc/my.cnf.d
  changed_when: true
  failed_when: false

- name: Display backup location
  ansible.builtin.debug:
    msg: "Slurm config backup created at: {{ backup_dir }}/{{ ctld_list[0] }}"
