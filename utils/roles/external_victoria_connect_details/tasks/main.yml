#  Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Check kubectl presence
  ansible.builtin.command: kubectl version --client=true
  register: kubectl_check
  changed_when: false
  failed_when: kubectl_check.rc != 0

- name: Get Victoria pods status
  ansible.builtin.shell: >-
    kubectl get pods -n {{ victoria_namespace }}
    -l "app in (vminsert,vmselect,vmstorage,victoriametrics)"
    -o wide
  register: victoria_pods
  changed_when: false
  failed_when: victoria_pods.rc != 0

- name: Get vminsert service LoadBalancer IP
  ansible.builtin.command: >-
    kubectl get svc vminsert -n {{ victoria_namespace }}
    -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: vminsert_lb_ip
  changed_when: false
  failed_when: false

- name: Get vminsert service LoadBalancer hostname
  ansible.builtin.command: >-
    kubectl get svc vminsert -n {{ victoria_namespace }}
    -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: vminsert_lb_hostname
  changed_when: false
  failed_when: false

- name: Get vminsert service external port
  ansible.builtin.command: >-
    kubectl get svc vminsert -n {{ victoria_namespace }}
    -o jsonpath='{.spec.ports[0].port}'
  register: vminsert_lb_port
  changed_when: false
  failed_when: false

- name: Get vmselect service LoadBalancer IP
  ansible.builtin.command: >-
    kubectl get svc vmselect -n {{ victoria_namespace }}
    -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: vmselect_lb_ip
  changed_when: false
  failed_when: false

- name: Get vmselect service LoadBalancer hostname
  ansible.builtin.command: >-
    kubectl get svc vmselect -n {{ victoria_namespace }}
    -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: vmselect_lb_hostname
  changed_when: false
  failed_when: false

- name: Get vmselect service external port
  ansible.builtin.command: >-
    kubectl get svc vmselect -n {{ victoria_namespace }}
    -o jsonpath='{.spec.ports[0].port}'
  register: vmselect_lb_port
  changed_when: false
  failed_when: false

- name: Set endpoint facts
  ansible.builtin.set_fact:
    vminsert_host: >-
      {{
        (vminsert_lb_ip.stdout | trim)
        if (vminsert_lb_ip.stdout | trim | length) > 0
        else (vminsert_lb_hostname.stdout | trim)
      }}
    vmselect_host: >-
      {{
        (vmselect_lb_ip.stdout | trim)
        if (vmselect_lb_ip.stdout | trim | length) > 0
        else (vmselect_lb_hostname.stdout | trim)
      }}
    vminsert_port: "{{ (vminsert_lb_port.stdout | trim) | default('') }}"
    vmselect_port: "{{ (vmselect_lb_port.stdout | trim) | default('') }}"
    victoria_tls_ca: "{{ victoria_tls_cert_dir }}/ca.crt"
    victoria_tls_cert: "{{ victoria_tls_cert_dir }}/server.crt"
    victoria_tls_key: "{{ victoria_tls_cert_dir }}/server.key"

- name: Fail when LoadBalancer IPs are not available
  ansible.builtin.fail:
    msg: >-
      Failed to fetch Victoria LoadBalancer IP(s). Ensure services 'vminsert' and 'vmselect'
      exist in namespace '{{ victoria_namespace }}' and have external IPs assigned.
  when:
    - vminsert_host | trim | length == 0 or vmselect_host | trim | length == 0

- name: Set Victoria external port fallbacks
  ansible.builtin.set_fact:
    vminsert_port: "8480"
    vmselect_port: "8481"
  when:
    - vminsert_port | trim | length == 0 or vmselect_port | trim | length == 0

- name: Build connection details
  ansible.builtin.set_fact:
    victoria_connect_details:
      victoria:
        namespace: "{{ victoria_namespace }}"
        pod_status: "{{ victoria_pods.stdout }}"
        base_url: "https://{{ vminsert_host }}:{{ vminsert_port }}"
        endpoints:
          vminsert:
            host: "{{ vminsert_host }}"
            port: "{{ vminsert_port | int }}"
            write_endpoint: "https://{{ vminsert_host }}:{{ vminsert_port }}/insert/0/prometheus/api/v1/write"
          vmselect:
            host: "{{ vmselect_host }}"
            port: "{{ vmselect_port | int }}"
            query_endpoint: "https://{{ vmselect_host }}:{{ vmselect_port }}/select/0/prometheus/api/v1/query"
            ui_url: "https://{{ vmselect_host }}:{{ vmselect_port }}/select/0/vmui"
        tls:
          server_crt: "{{ victoria_tls_cert }}"

- name: Ensure output directory exists
  ansible.builtin.file:
    path: "{{ victoria_output_file | dirname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  connection: local
  run_once: true

- name: Write connection details to file
  ansible.builtin.copy:
    content: "{{ victoria_connect_details | to_nice_yaml }}"
    dest: "{{ victoria_output_file }}"
    mode: "0644"
  delegate_to: localhost
  connection: local
  run_once: true

- name: Display Victoria connection details
  ansible.builtin.debug:
    msg: |
      Victoria connection details written to: {{ victoria_output_file }}

      Endpoints:
        vminsert write: https://{{ vminsert_host }}:{{ vminsert_port }}/insert/0/prometheus/api/v1/write
        vmselect query: https://{{ vmselect_host }}:{{ vmselect_port }}/select/0/prometheus/api/v1/query
        vmselect UI:    https://{{ vmselect_host }}:{{ vmselect_port }}/select/0/vmui

      TLS:
        server.crt: {{ victoria_tls_cert }}

      Pods:
      {{ victoria_pods.stdout }}
  delegate_to: localhost
  connection: local
  run_once: true
