{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "oim_ha": {
      "type": "object",
      "properties": {
        "enable_oim_ha": {
          "type": "boolean"
        },
        "admin_virtual_ip_address": {
          "type": "string"
        },
        "bmc_virtual_ip_address": {
          "type": "string"
        },
        "active_node_service_tag": {
          "type": "string"
        },
        "passive_nodes": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "properties": {
              "node_service_tags": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^[a-zA-Z0-9]+$"
                }
              }
            },
            "required": [
              "node_service_tags"
            ]
          }
        }
      },
      "required": [
        "enable_oim_ha"
      ],
      "allOf": [
        {
          "if": {
            "properties": {
              "enable_oim_ha": {
                "const": true
              }
            }
          },
          "then": {
            "required": [
              "admin_virtual_ip_address",
              "active_node_service_tag",
              "passive_nodes"
            ],
            "properties": {
              "admin_virtual_ip_address": {
                "type": "string",
                "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"
              },
              "bmc_virtual_ip_address": {
                "type": "string",
                "oneOf": [
                  {
                    "maxLength": 0
                  },
                  {
                    "minLength": 1,
                    "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"
                  }
                ]
              },
              "active_node_service_tag": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9]+$"
              },
              "passive_nodes": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "properties": {
                    "node_service_tags": {
                      "type": "array",
                      "minItems": 1,
                      "items": {
                        "type": "string",
                        "pattern": "^[a-zA-Z0-9]+$"
                      }
                    }
                  },
                  "required": [
                    "node_service_tags"
                  ]
                }
              }
            }
          }
        }
      ]
    },
    "service_node_ha": {
      "type": "object",
      "properties": {
        "enable_service_ha": {
          "type": "boolean",
          "const": false
        },
        "service_nodes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "virtual_ip_address": {
                "type": "string"
              },
              "active_node_service_tag": {
                "type": "string"
              },
              "passive_nodes": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "properties": {
                    "node_service_tags": {
                      "type": "array",
                      "items": {
                        "type": "string",
                        "pattern": "^[a-zA-Z0-9]+$"
                      }
                    }
                  },
                  "required": [
                    "node_service_tags"
                  ]
                }
              }
            },
            "required": [
              "virtual_ip_address",
              "active_node_service_tag",
              "passive_nodes"
            ]
          }
        }
      },
      "required": [
        "enable_service_ha"
      ]
    },
    "slurm_head_node_ha": {
      "type": "object",
      "items": {
        "type": "object",
        "properties": {
          "enable_slurm_ha": {
            "type": "boolean"
          },
          "virtual_ip_address": {
            "type": "string"
          },
          "active_node_service_tag": {
            "type": "string"
          },
          "passive_nodes": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "properties": {
                "node_service_tags": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "pattern": "^[a-zA-Z0-9]+$"
                  }
                }
              },
              "required": [
                "node_service_tags"
              ]
            }
          }
        },
        "required": [
          "enable_slurm_ha"
        ],
        "allOf": [
          {
            "if": {
              "properties": {
                "enable_slurm_ha": {
                  "const": true
                }
              }
            },
            "then": {
              "required": [
                "virtual_ip_address",
                "active_node_service_tag",
                "passive_nodes"
              ],
              "properties": {
                "virtual_ip_address": {
                  "type": "string",
                  "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"
                },
                "active_node_service_tag": {
                  "type": "string",
                  "pattern": "^[a-zA-Z0-9]+$"
                },
                "passive_nodes": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "object",
                    "properties": {
                      "node_service_tags": {
                        "type": "array",
                        "minItems": 1,
                        "items": {
                          "type": "string",
                          "pattern": "^[a-zA-Z0-9]+$"
                        }
                      }
                    },
                    "required": [
                      "node_service_tags"
                    ]
                  }
                }
              }
            }
          }
        ]
      }
    },
    "k8s_head_node_ha": {
      "type": "object",
      "properties": {
        "enable_k8s_ha": {
          "type": "boolean"
        },
        "virtual_ip_address": {
          "type": "string",
          "format": "ipv4"
        },
        "external_loadbalancer_ip": {
          "type": "string",
          "description": "Specify this to use an external load balancer instead of kube-vip as LB.",
          "format": "ipv4"
        },
        "loadbalancer_port": {
          "type": ["integer", "null"],
          "description": "The port must not be in use and cannot be 6443."
        },
        "active_node_service_tags": {
          "type": ["array", "null"],
          "items": {
            "type": "string",
            "minItems": 0,
            "pattern": "^[a-zA-Z0-9]+$"
          }
        }
      },
      "required": [
        "enable_k8s_ha"
      ],
      "allOf": [
        {
          "if": {
            "properties": {
              "enable_k8s_ha": {
                "const": true
              }
            }
          },
          "then": {
            "required": [
              "virtual_ip_address",
              "active_node_service_tags"
            ],
            "properties": {
              "virtual_ip_address": {
                "type": "string",
                "pattern": "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"
              },
              "active_node_service_tags": {
                "type": ["array", "null"],
                "minItems": 0,
                "items": {
                  "type": "string",
                  "pattern": "^[a-zA-Z0-9]+$"
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "external_loadbalancer_ip": {
                "type": "string",
                "minLength": 1
              }
            },
            "required": ["external_loadbalancer_ip"]
          },
          "then": {
            "required": ["loadbalancer_port"]
          }
        }
      ]
    }
  }
}